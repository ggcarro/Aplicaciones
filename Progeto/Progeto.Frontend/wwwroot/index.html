<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Progeto</title>

    <!-- JQuery -->
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>

    <!-- Ace -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js"></script>

    <!-- SVG PAN ZOOM -->
    <!-- <script src="https://github.com/ariutta/svg-pan-zoom/blob/master/src/svg-pan-zoom.js"></script> -->

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <!-- ACE Editor-->
    <script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
   
    <!-- LUA Functions -->
    <script>

        function SetupEditor() {
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/clouds");
            editor.getSession().setMode("ace/mode/lua");

            editor.commands.addCommand({
                name: 'RunProgramCommand',
                bindKey: { win: 'Ctrl-Enter', mac: 'Command-Enter' },
                exec: function (editor) {
                    Run(editor.getSession().getValue());
                }
            });
            editor.focus();
        }

        async function Run(source) {
            var serviceBase = 'http://localhost:5010/api/progeto';

            program = {};
            program.code = source;

            try {
                const response = await fetch(serviceBase, {
                    method: "post",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(program)
                });

                const data = await response.json();

                $('#result').html(data.output);
                $('#svg').html(data.svg);
                $('#temp').html("Time:" + data.time + " ms");


            } catch (error) {
                alert(error);
            }
            svgPanZoom('#drawing');
        }

        function Button() {
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/clouds");
            editor.getSession().setMode("ace/mode/lua");
            Run(editor.getSession().getValue());
            editor.focus();
        }

        function Save() {
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/clouds");
            editor.getSession().setMode("ace/mode/lua");
            Run(editor.getSession().getValue());

            var serviceBase = 'http://localhost:5010/api/progeto/save';

            program = {};
            program.code = source;

            try {
                const response = await fetch(serviceBase, {
                    method: "post",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(program)
                });

                const data = await response.json();

                $('#result').html(data.output);
                $('#svg').html(data.svg);
                $('#temp').html("Time:" + data.time + " ms");


            } catch (error) {
                alert(error);
            }
            svgPanZoom('#drawing');
        }
    </script>
    <script>
        var fileInput = document.getElementById('fileInput');
        var text;
        fileInput.addEventListener('change', function(e) {
            var file = fileInput.files[0];
            var textType = /text.*/;
    
            if (file.type.match(textType)) {
                var reader = new FileReader();
        
                reader.onload = function(e) {
                    var content = reader.result;
                    text = text + content;
                }
        
                reader.readAsText(file);	
            } else {
                alert("File not supported!")
            }
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/clouds");
            editor.getSession().setMode("ace/mode/lua");
            editor.getSession().setValue(text);
            editor.focus()
        });
    </script>

</head>
<style type="text/css">
    .border{border:solid 10px; border-color: black; padding:10px; width:100%}
    .c1{min-width: 49%; padding: 50px; height: 80vh;}
</style>

<body onload="SetupEditor()">
    <!--Navbar-->
    <nav class="navbar navbar-dark bg-dark">
        <a class="navbar-brand" href="#">Progeto</a>
        <button class="btn btn-outline-info my-2 my-sm-0" onclick="Button()">Run</button>
        <button class="btn btn-outline-info my-2 my-sm-0" onclick="Save()">Save</button>
    </nav>

    <!--Main Container-->
    <div class="containter">
        <div class="row">
            <div class="col-md-1 c1">
                <div class="row border" style="height:40vh" id="editor"></div>
                <textarea readonly class="row border" style="height:40vh" id="result"></textarea>
                <div id="temp"></div>
            </div>
            <div class="col-md-1 c1" style="padding:50px">
                <div class="row border" style="height:80vh" id="svg"></div>
            </div>
        </div>
        <div class="row">
            <input type="file" id=fileInput"/>
        </div>
    </div>
    
</body>

</html>
